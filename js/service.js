const u=250;const f=100;const n="jupiter_token_cache_v1";const p=15*60*1e3;async function m(){return new Promise(e=>{try{chrome.storage.local.get([n],t=>e(t[n]||{}))}catch(t){e({})}})}async function k(r){return new Promise(t=>{try{chrome.storage.local.set({[n]:r},()=>{t();setTimeout(()=>{o()["catch"](()=>{})},0)})}catch(e){t()}})}async function o(){try{const o=await m();const e=Object.keys(o);if(!e.length)return;const r=Date.now();const n=new Set;for(const s of e){const c=o[s];const l=Number(c?.fetchedAt||0);if(l&&r-l>p){n.add(s)}}const a=e.filter(t=>!n.has(t));if(a.length>u){a.sort((t,e)=>{const r=Number(o[t]?.fetchedAt||0);const n=Number(o[e]?.fetchedAt||0);return r-n});const i=a.length-f;for(let t=0;t<i;t++)n.add(a[t])}if(n.size===0)return;for(const s of Array.from(n))delete o[s];await k(o)}catch(t){}}async function y(t,r={},{attempts:n=3,delayBase:o=300,validate:a}={}){for(let e=0;e<n;e++){try{const c=await fetch(t,r);const l=await c.json()["catch"](()=>null);if(c.ok&&(!a||await a(c,l)))return{ok:true,json:l};throw new Error("invalid")}catch(s){if(e<n-1)await new Promise(t=>setTimeout(t,o*(e+1)))}}return{ok:false,error:"failed"}}async function i(e,{forceRefresh:t=false}={}){if(!e)return{ok:false,error:"no tokenId"};const r=Date.now();const n=await m();const o=n[e];if(!t&&o&&o.fetchedAt&&r-o.fetchedAt<p){return{ok:true,...o.data,cached:true}}const a=`https://lite-api.jup.ag/tokens/v2/search?query=${encodeURIComponent(e)}`;const s=await y(a,{method:"GET",headers:{Accept:"application/json"}},{attempts:3,delayBase:300,validate:async(t,e)=>{if(!e)return false;if(Array.isArray(e))return e.length>0;return true}});if(!s.ok){n[e]={fetchedAt:r,data:{ok:false,error:s.error||"fetch_failed"}};await k(n);return{ok:false,error:s.error||"fetch_failed"}}const c=s.json;const l=Array.isArray(c)?c.find(t=>t.id===e)||c[0]||null:null;if(!l){n[e]={fetchedAt:r,data:{ok:false,error:"not_found"}};await k(n);return{ok:false,error:"not_found"}}const i={name:l.name??null,symbol:l.symbol??null,icon:l.icon??null,twitter:l.twitter??null,website:l.website??null,dev:l.dev??null,createdAt:l.firstPool?.createdAt??null,holderCount:l.holderCount??null,mcap:l.mcap??l.fdv??null,stats5m:l.stats5m?.priceChange??null,stats1h:l.stats1h?.priceChange??null,stats6h:l.stats6h?.priceChange??null,stats24h:l.stats24h?.priceChange??null,ok:true};let u=l.graduatedPool??null;let f=l.firstPool?.createdAt??null;if(!u){try{const h=await sol_fetchLpDexscreener(e);if(h&&h.ok){u=h.pairAddress||u;if(!i.createdAt&&h.pairCreatedAt){f=h.pairCreatedAt}}}catch(d){}}i.lpAddress=u||null;i.createdAt=f||i.createdAt||null;n[e]={fetchedAt:r,data:i};await k(n);return{ok:true,...i}}async function d(e,{forceRefresh:t=false}={}){if(!e)return{ok:false,error:"no tokenId"};const r=Date.now();const n=await m();const o=n[e];if(!t&&o&&o.fetchedAt&&r-o.fetchedAt<p){return{ok:true,...o.data,cached:true}}const a=`https://four.meme/meme-api/v1/private/token/get/v2?address=${encodeURIComponent(e)}`;const s=await y(a,{method:"GET",headers:{Accept:"application/json"}},{attempts:3,delayBase:300,validate:async(t,e)=>{if(!e)return false;if(Array.isArray(e))return e.length>0;if(typeof e==="object"){if(e.data){const r=e.data;return!!(r.id||r.address||r.name||r.image)}return!!(e.id||e.address||e.name||e.image)}return false}});if(!s.ok){n[e]={fetchedAt:r,data:{ok:false,error:s.error||"fetch_failed"}};await k(n);return{ok:false,error:s.error||"fetch_failed"}}const c=s.json;let l=null;if(Array.isArray(c)){l=c.find(t=>t.id===e||t.address===e)||c[0]||null}else if(c&&typeof c==="object"){if(c.data){l=c.data}else{l=c}}if(!l){n[e]={fetchedAt:r,data:{ok:false,error:"not_found"}};await k(n);return{ok:false,error:"not_found"}}const i=l;const u={name:i.name??null,symbol:i.shortName??null,icon:i.image??null,twitter:i.twitterUrl??null,website:i.webUrl??null,dev:i.userAddress??null,createdAt:i.launchTime??i.createDate??null,holderCount:i.holderCount??null,mcap:i.tokenPrice?.marketCap??null,stats5m:i.tokenPrice?.priceChange5??null,stats1h:i.tokenPrice?.priceChange1??null,stats6h:i.tokenPrice?.priceChange6??null,stats24h:i.tokenPrice?.dayIncrease??null,ok:true};n[e]={fetchedAt:r,data:u};await k(n);return{ok:true,...u}}const t={DevMode:false,ExtensionEnabled:true,ExtensionVersion:1.1,lastRequest:0,init:false};const e={"null":null,lastCheck:0};async function r(){await chrome.storage.local.set({BSC_Options:t});await chrome.storage.local.set({BSC:e});await chrome.storage.local.set({BSC_Cache:BSC_Cache})}function a(e){return new Promise(t=>chrome.storage.local.get(e,t))}function s(e){return new Promise(t=>chrome.storage.local.set(e,t))}const w=250;const A=150;const g=24*60*60*1e3;let c=0;const l=60*60*1e3;const h=20*1e3;const C=new Map;let b={};let S={};let _=null;async function B(){try{const{BSC_Data:e={}}=await chrome.storage.local.get("BSC_Data");b=e.BSC_Tokens||{}}catch(t){b={}}}async function T(t,e){b[t]={...b[t]||{},...e,timestamp:Date.now()};S[t]=b[t];I();v()}async function D(t){if(b[t])return b[t];try{const{BSC_Data:r={}}=await chrome.storage.local.get("BSC_Data");b=r.BSC_Tokens||b;return b[t]||null}catch(e){return null}}function E(){return{...b}}async function v(){const t=Date.now();if(t-c<l)return;c=t;try{await P()}catch(e){}}async function P(){try{const e=await new Promise(t=>chrome.storage.local.get("BSC_Data",t));const r=e?.BSC_Data||{};const n=r.BSC_Tokens||{};const o=Object.entries(n);if(!o.length)return;const a=Date.now();const s=new Set;for(const[i,u]of o){const f=u?.timestamp||u?.lastUpdated||u?.lastFetched||0;const d=a-(Number(f)||0);if(d>g){s.add(i)}}const c=o.filter(([t])=>!s.has(t));if(c.length>w){c.sort((t,e)=>{const r=Number(t[1]?.timestamp||t[1]?.lastUpdated||0)||0;const n=Number(e[1]?.timestamp||e[1]?.lastUpdated||0)||0;return r-n});const h=c.length-A;for(let t=0;t<h;t++){s.add(c[t][0])}}if(s.size===0)return;for(const i of Array.from(s)){delete n[i];delete b[i]}const l={...r,BSC_Tokens:n};await new Promise(t=>{try{chrome.storage.local.set({BSC_Data:l},()=>t())}catch(e){t()}})}catch(t){}}function I(){if(_)return;_=setTimeout(async()=>{try{const{BSC_Data:e={}}=await chrome.storage.local.get("BSC_Data");const r={...e.BSC_Tokens||{},...S};await chrome.storage.local.set({BSC_Data:{...e,BSC_Tokens:r}});b=r}catch(t){}finally{S={};_=null}},500)}function M(t){if(!t||!t.timestamp)return false;return Date.now()-t.timestamp<h}const j=new Map;async function U(a,s){const t=String(s);if(j.has(t)){try{return await j.get(t)}catch(c){}}const e=(async()=>{try{const e=await D(s)["catch"](()=>null);if(e?.lpAddress){return{ok:true,lpAddress:e.lpAddress,createdAt:e.createdAt??null}}const r=[];if(a==="four"){if(Math.random()<.5)r.push(R,L);else r.push(L,R)}else{r.push(L)}for(const n of r){if(!n)continue;try{const o=await n(s);if(o){try{await T(s,{lpAddress:o.lpAddress,createdAt:o.createdAt??null})}catch(c){}return{ok:true,lpAddress:o.lpAddress,createdAt:o.createdAt??null}}}catch(c){}}return{ok:false,error:"(BSC) no lp found"}}catch(t){return{ok:false,error:String(t)}}})();j.set(t,e);try{return await e}finally{j["delete"](t)}}async function L(t){try{const r=`https://api.dexscreener.com/token-pairs/v1/bsc/${t}`;const n=await fetch(r);if(!n.ok)return null;const o=await n.json();const a=Array.isArray(o)?o:Array.isArray(o.pairs)?o.pairs:Array.isArray(o.data)?o.data:[];if(!Array.isArray(a)||a.length===0)return null;const s=a[0]||{};const c=s.pairAddress||s.lp||s.pair_address||null;if(!c)return null;const l=s.pairCreatedAt||s.pair_created_at||s.createdAt||null;const i=c.replace(/:\d+(?=[^:]*$)/,"");return{lpAddress:i,createdAt:typeof l==="number"&&l>0?l:null}}catch(e){return null}}async function R(e){try{const r=`https://four.meme/meme-api/v1/private/token/get/v2?address=${e}`;const n=await fetch(r);if(!n.ok)return null;const o=await n.json();let t=null;if(Array.isArray(o)&&o.length){t=o[0]}else if(o&&typeof o==="object"){t=o.data||o.coin||o||null}if(!t||typeof t!=="object")return null;const a=t.dexPair?.pairAddress||t.pairAddress||t.address||null;const s=t.launchTime||null;return{lpAddress:a,createdAt:typeof s==="number"&&s>0?s:null}}catch(t){return null}}async function $(t,e={}){const r=typeof e.timeoutMs==="number"?e.timeoutMs:8e3;const n=Array.isArray(e.gateways)?e.gateways:[];const o=[e.quicknodeUrl&&e.quicknodeUrl.replace(/\/$/,"")?`${e.quicknodeUrl}/ipfs/`:"https://quicknode.quicknode-ipfs.com/ipfs/","https://gateway.pinata.cloud/ipfs/","https://dweb.link/ipfs/","https://ipfs.io/ipfs/","https://cloudflare-ipfs.com/ipfs/"];const a=n.length?n.concat(o):o;function s(t){if(!t)return null;const e=String(t);const r=e.match(/ipfs:\/\/([^/?#]+)/i);if(r)return r[1];const n=e.match(/\/ipfs\/([^/?#]+)/i);if(n)return n[1];const o=e.trim();if(/^[A-Za-z0-9]+$/.test(o)&&o.length>=20&&o.length<=120)return o;return null}function c(n,o){return new Promise(e=>{const t=new AbortController;const r=setTimeout(()=>{t.abort();e(null)},o);fetch(n,{signal:t.signal}).then(t=>{clearTimeout(r);e(t)})["catch"](()=>{clearTimeout(r);e(null)})})}function l(o){return new Promise((t,e)=>{try{const n=new FileReader;n.onerror=()=>{n.onload=n.onerror=null;e(new Error("fileReader-error"))};n.onload=()=>{n.onload=n.onerror=null;t(n.result)};n.readAsDataURL(o)}catch(r){e(r)}})}try{if(!t)return{ok:false,error:"no-url"};const f=String(t);if(/^https?:\/\//i.test(f)&&!/\/ipfs\//i.test(f)&&!/^ipfs:\/\//i.test(f)){try{const p=await c(f,r);if(p&&p.ok){const m=(p.headers.get("content-type")||"").toLowerCase();if(m.startsWith("image")){const k=await p.blob();const y=await l(k);return{ok:true,url:y}}else{const w=await p.blob()["catch"](()=>null);if(w&&w.type&&w.type.startsWith("image")){const y=await l(w);return{ok:true,url:y}}}}}catch(i){}}const d=s(f);if(!d){return{ok:false,error:"no-cid"}}for(const A of a){if(!A)continue;const g=A.endsWith("/")?A+d:A+d;try{const C=await c(g,r);if(!C||!C.ok)continue;const m=(C.headers.get("content-type")||"").toLowerCase();if(m.startsWith("image")){const k=await C.blob();const y=await l(k);return{ok:true,url:y}}const w=await C.blob()["catch"](()=>null);if(w&&w.type&&w.type.startsWith("image")){const y=await l(w);return{ok:true,url:y}}}catch(i){}}const h=["dweb.link","gateway.pinata.cloud","ipfs.io","cloudflare-ipfs.com"];for(const b of h){const g=`https://${d}.ipfs.${b}/`;try{const C=await c(g,r);if(!C||!C.ok)continue;const m=(C.headers.get("content-type")||"").toLowerCase();if(m.startsWith("image")){const k=await C.blob();const y=await l(k);return{ok:true,url:y}}const w=await C.blob()["catch"](()=>null);if(w&&w.type&&w.type.startsWith("image")){const y=await l(w);return{ok:true,url:y}}}catch(i){}}return{ok:false,error:"no-image-found"}}catch(u){return{ok:false,error:String(u)}}}chrome.runtime.onMessage.addListener((c,t,r)=>{let n=false;const l=t=>{if(n)return;n=true;try{r(t)}catch(e){}};(async()=>{try{const{type:r,tokenId:n}=c||{};if(r==="getToken"){const o=await bgGetToken(c.tokenId);l({ok:true,token:o||null});return}if(r==="getAllTokens"){l({ok:true,Tokens:bgGetAllTokens()});return}if(r==="setToken"){await bgSetToken(c.tokenId,{data:c.data??null,lpAddress:c.lpAddress??null,isError:!!c.isError,failed:typeof c.failed==="number"?c.failed:Tokens[c.tokenId]?.failed||0});l({ok:true});return}if(r==="bsc_fetchDateAndLp"){const{platform:a,tokenId:n}=c;try{const s=await U(a,n);if(s&&s.ok)l({ok:true,createdAt:s.createdAt??null,lpAddress:s.lpAddress??null});else l({ok:false,error:s?.error||"[BSC] no date or lp received"})}catch(t){l({ok:false,error:String(t)})}return}if(r==="fetch-ipfs-image"&&c.url){try{const s=await $(c.url,{timeoutMs:5e3});if(s&&s.ok)l(s);else l({ok:false,error:s?.error||"no ipfs image"})}catch(t){l({ok:false,error:String(t)})}return}if(r==="sol_fetchDateAndLp"){const{platform:a,tokenId:n}=c;try{const s=await sol_fetchDateAndLp(a,n);if(s&&s.ok)l({ok:true,createdAt:s.createdAt??null,lpAddress:s.lpAddress??null});else l({ok:false,error:s?.error||"[SOL] no date or lp received"})}catch(t){l({ok:false,error:String(t)})}return}if(r==="fetchInfoSolJupiter"){if(!n){l({ok:false,error:"no tokenId"});return}try{if(typeof i!=="function"){l({ok:false,error:"getSolTokenInfo not implemented"});return}const s=await i(n,{forceRefresh:false});if(s&&s.ok){l(s)}else{l({ok:false,error:s?.error||"no meta"})}}catch(t){l({ok:false,error:String(t)})}return}if(r==="fetchInfoBscFour"){if(!n){l({ok:false,error:"no tokenId"});return}try{if(typeof d!=="function"){l({ok:false,error:"getBscTokenInfo not implemented"});return}const s=await d(n,{forceRefresh:false});if(s&&s.ok){l(s)}else{l({ok:false,error:s?.error||"no meta"})}}catch(t){l({ok:false,error:String(t)})}return}l({ok:false,error:"BG: Unknown message"});return}catch(t){console.error("BG: Message handler error",t);try{l({ok:false,error:t?.message||String(t)})}catch(e){}return}})();return true});